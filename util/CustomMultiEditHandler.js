/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/EventProvider"],function(E){"use strict";var f=function(c,t){var d=c.getMetadata?c.getMetadata().getDefaultAggregation():{};if(d&&d._sGetter){var a=c[d._sGetter]();return a.reduce(function(i,I){if(I instanceof t){i.push(I);return i;}if(!I.getMetadata){return i;}var s=f(I,t);if(s&&s.length){return i.concat(s);}return i;},[]);}return[];},_=sap.ui.model.odata.type.DateTime.extend("i2d.eam.order.manages1.util.CustomMultiEditHandler.dateType",{_oViewModelContext:null,constructor:function(v){this._oViewModelContext=v;return sap.ui.model.odata.type.DateTime.call(this,undefined,{displayFormat:"Date"});},formatValue:function(v,t){if(v instanceof Date){return sap.ui.model.odata.type.DateTime.prototype.formatValue.apply(this,arguments);}else if(typeof v==="undefined"){return null;}return v;},parseValue:function(v,s){if(s==="string"){if(this._oViewModelContext.getProperty("massEditValues").some(function(o){return(o.semantic!=="ConcreteValue"&&o.value===v);})){return v;}}var p=sap.ui.model.odata.type.DateTime.prototype.parseValue.apply(this,arguments);if(this.formatValue(p,"string")!==v){throw new sap.ui.model.ParseException(sap.ui.getCore().getLibraryResourceBundle().getText("EnterDate",[this.formatValue(new Date(Date.UTC(new Date().getFullYear(),11,31)),"string")]));}return p;},validateValue:function(){return;}});return E.extend("i2d.eam.order.manages1.util.CustomMultiEditHandler",{_aFields:null,_aDependentFields:null,_mFieldDependencies:null,_oModel:null,_oViewModel:null,_sDialogFragment:null,_sActionName:null,_oEntityType:null,_oDialog:null,_oParameterContext:null,constructor:function(m,a,d){E.prototype.constructor.call(this);this._oModel=m;this._sActionName=a;this._sDialogFragment=d;var M=this._oModel.getMetaModel(),F=M.getODataFunctionImport("EAM_OBJPG_MAINTENANCEORDER_SRV.EAM_OBJPG_MAINTENANCEORDER_SRV_Entities/"+this._sActionName);this._oEntityType=M.getODataEntityType(F["sap:action-for"]);this._aFields=F.parameter.reduce(function(b,p){if(this._oEntityType.key.propertyRef.filter(function(k){return k.name===p.name;}).length>0){return b;}b.push(p.name);return b;}.bind(this),[]);this._aDependentFields=[];},showDialog:function(p,c){var t=this,P={},a=[],o=p.getController().extensionAPI,m=this._oModel.getMetaModel();this._aFields.forEach(function(s){var e=m.getODataProperty(t._oEntityType,s);if(e&&e["com.sap.vocabularies.Common.v1.Text"]&&e["com.sap.vocabularies.Common.v1.Text"].Path){var g=e["com.sap.vocabularies.Common.v1.Text"].Path.split("/");if(g.length===2){a.push(g[0]);}t._aDependentFields.push(g.join("/"));}if(e&&e["com.sap.vocabularies.Common.v1.ValueList"]){e["com.sap.vocabularies.Common.v1.ValueList"].Parameters.forEach(function(v){if(!v.RecordType||v.RecordType.indexOf("ValueListParameterInOut")===-1||!v.LocalDataProperty||!v.LocalDataProperty.PropertyPath||v.LocalDataProperty.PropertyPath===s||t._aFields.indexOf(v.LocalDataProperty.PropertyPath)!==-1){return;}t._aDependentFields.push(v.LocalDataProperty.PropertyPath);});}});this._mFieldDependencies=this._aFields.reduce(function(M,s){M[s]=[];return M;},{});var F=this._aFields.concat(this._aDependentFields).filter(function(s){return c.filter(function(S){return typeof S.getProperty(s)==="undefined";}).length>0;}),b;this.fireEvent("beforeRetrieveMissingData",{select:F,expand:a});if(F.length){b=Promise.all(c.map(function(s){return new Promise(function(r,e){t._oModel.read(s.getPath(),{urlParameters:{$select:F.join(),$expand:a.join()},success:r,error:e});});}));}else{b=Promise.resolve();}this._prepareModel();var d=this._oModel.createEntry(c[0].getPath().match(/^\/(.*?)\(.*\)$/)[1],{groupId:"BreakoutActionParameters",properties:this._aFields.concat(this._aDependentFields).reduce(function(M,s){M[s]=null;return M;},{})});this._oParameterContext=d;b.then(function(){var v=t._proposeParametersForMassEdit(p,c,d,P);v.IsInValueHelpMode=true;var V=new sap.ui.model.json.JSONModel(v);t._oViewModel=V;t._aFields.concat(t._aDependentFields).forEach(function(s){var S=v[s]?v[s].selectedKey:d.getProperty(s);try{t.fireEvent("valueOptionSelected",{isFirstTime:true,isKeep:S==="_KEEP",isLeaveBlank:!S||S==="_BLANK",isConcreteValue:S&&S.substring(0,1)!=="_",isCustomOption:false,fieldName:s,selectedOptionKey:S,selectedCustomOptionItem:null},true);}catch(e){}});t._showDialog(p,t._sDialogFragment,o,d,V).then(function(i){if(!i){return Promise.resolve();}var e=t._getParametersForSubmit(d);return o.securedExecution(jQuery.proxy(t._splitActionInvocationForMassEdit,t,c,t._sActionName,e,V.getProperty("/"),o),{dataloss:{popup:false}});}).then(function(){t._oModel.deleteCreatedEntry(d);});});o.securedExecution(function(){return b;},{dataloss:{popup:false}});},getDialog:function(){return this._oDialog;},getCustomValueOptions:function(F){return this._oViewModel.getProperty("/"+F+"/massEditValues").reduce(function(o,i){if(i.semantic==="Custom"){o.push(sap.ui.getCore().byId(i.id));}return o;},[]);},setCustomValueOptions:function(F,o){var s=-1,O=this._oViewModel.getProperty("/"+F+"/massEditValues").filter(function(i,I){if(i.semantic!=="Custom"&&i.semantic!=="ConcreteValue"){s=I+1;}return i.semantic!=="Custom";}),c=function(i){return i.key===S&&i.semantic==="Custom";};if(s===-1){s=O.length;}var S=this._oViewModel.getProperty("/"+F+"/selectedKey"),a,b=this._oViewModel.getProperty("/"+F+"/massEditValues").some(c);var C=o.reduce(function(A,i){if(i.getKey()===S){a=i;}return A.concat({key:i.getKey(),value:i.getText(),id:i.getId(),semantic:"Custom"});},[]);Array.prototype.splice.apply(O,[s,0].concat(C));this._oViewModel.setProperty("/"+F+"/massEditValues",O);if(b){if(O.some(c)){try{this.fireEvent("valueOptionSelected",{isFirstTime:false,isKeep:false,isLeaveBlank:false,isConcreteValue:true,isCustomOption:true,fieldName:F,selectedOptionKey:S,selectedCustomOptionItem:a},true);}catch(e){}}else{this._processParametersForMassEdit(this._oDialog.getBindingContext(),this._oViewModel,F);}}},_showDialog:function(p,F,o,c,v){var t=this;return new Promise(function(r,a){var d=sap.ui.xmlfragment(F,new(sap.ui.core.mvc.Controller.extend(F+"Controller",{afterDialogClosed:function(){p.removeDependent(d);d.destroy();},onOkPressed:function(){if(sap.ui.getCore().getMessageManager().getMessageModel().getObject("/").some(function(m){if(m.getType()===sap.ui.core.MessageType.Error){var C=sap.ui.getCore().byId(m.getControlId());if(C instanceof sap.m.InputBase){C.focus();}return true;}return false;})){return;}d.close();r(true);},onCancelPressed:function(){d.close();r(false);},onMassEditComboBoxChanged:function(b){var C,g=b.getSource(),S=g.getSelectedItem(),i=g.getBindingContext(),V=g.getBindingContext("viewModel"),h=V.getPath().substring(1),P=V.getProperty("previousSelectedKey"),j=sap.ui.getCore().byId(g.data("smartFieldId"));try{C=t.fireEvent("valueOptionSelected",{isKeep:S&&S.data("semantic")==="KeepValue"||false,isLeaveBlank:S&&S.data("semantic")==="LeaveBlank"||false,isConcreteValue:S&&S.data("semantic")==="ConcreteValue"||(S?false:true),isCustomOption:S&&S.data("semantic")==="Custom"||false,fieldName:h,inputContext:i,selectedOptionKey:S?S.getKey():g.getValue(),selectedCustomOptionItem:S&&S.data("semantic")?sap.ui.getCore().byId(S.getBindingContext("viewModel").getProperty("id")):null},true);}catch(e){}t._oViewModel.setProperty("previousSelectedKey",S?S.getKey():"",V);if(C===false){return;}switch(S?S.getKey():""){case"_BLANK":t._oModel.setProperty(i.getPath()+V.getPath(),"");t._recalculateDependentLabels(h);break;case"_SELECT":v.setProperty("isSingleMode",true,V);var D,I=j.getInnerControls().filter(function(n){return n instanceof sap.m.Input;})[0];if(!I){D=j.getInnerControls().filter(function(n){return n instanceof sap.m.DatePicker;})[0];}if(!I&&D){D.attachEventOnce("change",function(){t._raiseEventAfterNewValueSelected(h,D.getValue());t._processParametersForMassEdit(i,v);v.setProperty("isSingleMode",false,V);g.focus();},t);return;}I.fireValueHelpRequest({fromSuggestions:false});var l=true;j.attachEventOnce("valueListChanged",function(b){l=false;});var m={onfocusin:function(){I.removeEventDelegate(m,t);var n=I.getValue();if(n){t._raiseEventAfterNewValueSelected(h,I.getValue());t._processParametersForMassEdit(i,v);}else if(!l){t._setNewValueManually(h,"_BLANK");}else{t._setNewValueManually(h,P);}v.setProperty("isSingleMode",false,V);g.focus();}};I.addEventDelegate(m,t);break;default:var k=g.getValue();if(k.indexOf("\u200c")===0){k="";}t._oModel.setProperty(i.getPath()+V.getPath(),S?S.getBindingContext("viewModel").getProperty("originalValue"):k);t._recalculateDependentLabels(h);t._processParametersForMassEdit(i,v);}}}))());if(v&&v.getProperty("/isMassEdit")===true){v.setProperty("/isMassEdit",false);d.attachEventOnce("afterOpen",jQuery.proxy(v.setProperty,v,"/isMassEdit",true));}o.attachToView(d);if(c){d.setBindingContext(c);}if(v){d.setModel(v,"viewModel");}try{t.fireEvent("beforeDialogOpens",{dialog:d});}catch(e){}d.open();t._oDialog=d;var s=f(t._oDialog,sap.ui.comp.smartform.GroupElement.prototype.constructor);s.forEach(function(b){var V=b.getBindingContext("viewModel");if(V&&V.getProperty("dataType")==="Edm.DateTime"){f(b,sap.m.ComboBox.prototype.constructor).some(function(C){t._oViewModel.setProperty("parsedValue",C.getValue(),V);C.bindValue({path:"viewModel>parsedValue",type:new _(V)});return true;});}});});},_setNewValueManually:function(F,k){var i=this._oViewModel.createBindingContext("/"+F);this._oViewModel.setProperty("selectedKey",k,i);var n=i.getProperty("massEditValues").filter(function(d){return d.key===k;})[0],s=sap.ui.getCore().byId(n.id);try{this.fireEvent("valueOptionSelected",{isKeep:s&&s.data("semantic")==="KeepValue",isLeaveBlank:s&&s.data("semantic")==="LeaveBlank",isConcreteValue:s&&s.data("semantic")==="ConcreteValue",isCustomOption:s&&s.data("semantic")==="Custom",fieldName:F,inputContext:i,selectedOptionKey:s?s.getKey():"",selectedCustomOptionItem:s},true);}catch(e){}},_raiseEventAfterNewValueSelected:function(F,v){try{this.fireEvent("valueOptionSelected",{isFirstTime:false,isKeep:false,isLeaveBlank:false,isConcreteValue:true,isCustomOption:false,fieldName:F,selectedOptionKey:v,selectedCustomOptionItem:null},true);}catch(e){}},_proposeParameters:function(s,I,p,r){var d=function(c,B){return c-B;},g=function(V){return function(c){return c&&V&&c.getTime()===V.getTime();};},F=this._aFields.concat(this._aDependentFields),a=F.reduce(function(M,c){if(!M[c]){M[c]=c;}return M;},p||{}),m=s[0].getObject(),A=r?F.reduce(function(M,c){M[c]=[m[a[c]]];return M;},{}):{};for(var i=1;i<s.length;i++){if(r){for(var k in A){var b;if(A.hasOwnProperty(k)){var v=s[i].getProperty(a[k]);b=b||v instanceof Date;if((!b&&A[k].indexOf(v)===-1)||(b&&!A[k].some(g(v)))){A[k].push(v);if(A[k].length===2){F.splice(F.indexOf(k),1);}}}if(b){A[k].sort(d);}else{A[k].sort();}b=false;}}else{F=jQuery.map(F,function(c){return s[i].getProperty(a[c])===m[a[c]]?c:null;});}}for(i=0;i<F.length;i++){if(!m[a[F[i]]]){continue;}I.getModel().setProperty(I.getPath()+"/"+F[i],m[a[F[i]]]);}return r?A:undefined;},_proposeParametersForMassEdit:function(p,s,i,P){var I=p.getModel("@i18n"),m=this._oModel.getMetaModel(),o=this._oEntityType,a=this._proposeParameters(s,i,P||{},true),t=[{key:"_BLANK",value:"\u200c"+I.getProperty("xlst.leaveBlank"),semantic:"LeaveBlank"},{key:"_KEEP",value:"\u200c"+I.getProperty("xlst.keepExistingValues"),semantic:"KeepValue"},{key:"_SELECT",value:"\u200c"+I.getProperty("xlst.useValueHelp"),semantic:"SelectValue"}],v={},r={isMassEdit:s.length>1};for(var k in a){if(a.hasOwnProperty(k)&&this._aDependentFields.indexOf(k)===-1){var h=false;if(!r.isMassEdit){r[k]={isSingleMode:true};continue;}v[k]=jQuery.extend([],t);if(a[k].length>1||(a[k][0]!==""&&a[k][0]!==null&&a[k][0]!=="0"&&a[k][0]!==undefined)){v[k]=v[k].concat(a[k].reduce(function(V,c){if(!c||c==="0"){h=true;return V;}return V.concat({key:c.toString(),originalValue:c,value:this._formatLabel(c,k),semantic:"ConcreteValue"});}.bind(this),[]));}else{v[k].splice(1,1);}r[k]={isSingleMode:false,sourceFieldName:P?P[k]||k:k,selectedKey:h||v[k].length>4?"_KEEP":a[k][0]||"_BLANK",massEditValues:v[k]};if(r[k].selectedKey==="0"){r[k].selectedKey="_BLANK";}r[k].previousSelectedKey=r[k].selectedKey;var b=m.getODataProperty(o,k);r[k].dataType=b&&b.type?b.type:"Edm.String";if(!b||(!b["com.sap.vocabularies.Common.v1.ValueList"]&&b.type!=="Edm.DateTime")){r[k].massEditValues.splice(r[k].massEditValues[1].key==="_SELECT"?1:2,1);}if(b&&b.type==="Edm.DateTime"){if(r[k].selectedKey!=="_BLANK"){r[k].massEditValues[1]=jQuery.extend({},r[k].massEditValues[1],{value:"\u200c"+I.getProperty("xlst.keepExistingDates")});r[k].massEditValues[2]=jQuery.extend({},r[k].massEditValues[2],{value:"\u200c"+I.getProperty("xlst.selectNewDate")});}else{r[k].massEditValues[1]=jQuery.extend({},r[k].massEditValues[1],{value:"\u200c"+I.getProperty("xlst.selectNewDate")});}}if(b&&b["com.sap.vocabularies.Common.v1.FieldControl"]&&jQuery.sap.endsWith(b["com.sap.vocabularies.Common.v1.FieldControl"].EnumMember,"Mandatory")){r[k].massEditValues.splice(0,1);}}}return r;},_formatLabel:function(v,F){if(v instanceof Date){return sap.ui.core.format.DateFormat.getDateInstance().format(v);}if(this._oEntityType&&F){var m=this._oModel.getMetaModel(),o=m.getODataProperty(this._oEntityType,F),t;if(o&&o["com.sap.vocabularies.Common.v1.ValueList"]){var V=o["com.sap.vocabularies.Common.v1.ValueList"],a=m.getODataEntityType(m.getODataEntitySet(V.CollectionPath.String).entityType),b;var K=this._oModel.createKey("/"+V.CollectionPath.String,V.Parameters.reduce(function(d,g){if(g.RecordType.indexOf("ValueListParameterIn")!==-1){if(g.LocalDataProperty.PropertyPath===F){d[g.ValueListProperty.String]=v;b=m.getODataProperty(a,g.ValueListProperty.String);}else{d[g.ValueListProperty.String]=this._oParameterContext.getProperty(g.LocalDataProperty.PropertyPath);this._registerFieldDependency(g.LocalDataProperty.PropertyPath,F);}}return d;}.bind(this),{}));if(b&&b["com.sap.vocabularies.Common.v1.Text"]&&b["com.sap.vocabularies.Common.v1.Text"].Path){t=this._oModel.getProperty(K+"/"+b["com.sap.vocabularies.Common.v1.Text"].Path);}if(!t){var A=this._oModel.getProperty("/"),l=V.Parameters.reduce(function(d,g){if(g.RecordType.indexOf("ValueListParameterIn")!==-1){if(g.LocalDataProperty.PropertyPath===F){d[g.LocalDataProperty.PropertyPath]=v;}else{d[g.LocalDataProperty.PropertyPath]=this._oParameterContext.getProperty(g.LocalDataProperty.PropertyPath);this._registerFieldDependency(g.LocalDataProperty.PropertyPath,F);}}return d;}.bind(this),{});if(o["com.sap.vocabularies.Common.v1.Text"]&&o["com.sap.vocabularies.Common.v1.Text"].Path&&Object.values(l).indexOf(null)===-1){for(var k in A){if(A.hasOwnProperty(k)){var e=A[k];if(!e.__metadata||e.__metadata.type.indexOf(this._oEntityType.name)===-1){continue;}var c=true;for(var j in l){if(l.hasOwnProperty(j)){if(e[j]!==l[j]){c=false;break;}}}if(c){t=this._oModel.getProperty("/"+e.__metadata.id.split("/").pop()+"/"+o["com.sap.vocabularies.Common.v1.Text"].Path);break;}}}}}}if(t){return t+" ("+v+")";}}return v;},_registerFieldDependency:function(s,t){if(this._mFieldDependencies[s]&&this._mFieldDependencies[s].indexOf(t)===-1){this._mFieldDependencies[s].push(t);}},_recalculateDependentLabels:function(F){if(!this._mFieldDependencies[F]){return;}this._mFieldDependencies[F].forEach(function(d){var a=this._oViewModel.getProperty("/"+d+"/massEditValues");a.forEach(function(v){if(v.semantic==="ConcreteValue"){v.value=this._formatLabel(v.originalValue,d);}}.bind(this));this._oViewModel.setProperty("/"+d+"/massEditValues",a);}.bind(this));},_processParametersForMassEdit:function(i,v,F){var p=i.getObject(),V=v.getProperty("/");for(var k in p){if(!V[k]||!V[k].massEditValues||(F&&F!==k)){continue;}if((["_KEEP","_BLANK"].indexOf(V[k].selectedKey)!==-1&&p[k])||(p[k]&&p[k]!==V[k].selectedKey)){V[k].selectedKey=p[k];if(!V[k].massEditValues.some(function(I){return I.key===(p[k]?p[k].toString():p[k]);})){V[k].massEditValues=V[k].massEditValues.filter(function(I){return I.isTemporary!==true;});V[k].massEditValues.push({key:p[k].toString(),originalValue:p[k],value:this._formatLabel(p[k],k),isTemporary:true,semantic:"ConcreteValue"});}v.setProperty("/"+k+"/",V[k]);}else if(V[k].selectedKey===""){V[k].selectedKey=V[k].massEditValues[0].key;v.setProperty("/"+k+"/",V[k]);}}},_getParametersForSubmit:function(c){var p=c.getObject(),v=this._oViewModel.getProperty("/");Object.keys(p).forEach(function(k,i){if(k.substring(0,1)==="_"){delete p[k];}else if(v[k]&&typeof v[k].parsedValue!=="undefined"&&v[k].parsedValue instanceof Date){p[k]=v[k].parsedValue;}});return p;},_splitActionInvocationForMassEdit:function(c,a,p,m,e){var C=c.slice(0),P=Promise.resolve(),b=function(o){var g=this._aFields.reduce(function(h,s){h[s]=p[s];return h;},{});for(var k in m){if(m[k].selectedKey==="_KEEP"){g[k]=o.getProperty(m[k].sourceFieldName);}if(m[k].selectedKey==="_BLANK"||g[k]===null){delete g[k];}}return g;}.bind(this);for(var i=0;i<C.length;i++){if(C[i]===null){continue;}var d=[C[i]],M=b(C[i],p,m);for(var j=i+1;j<C.length;j++){if(C[j]===null){continue;}var F=b(C[j],p,m);if(jQuery.sap.equal(M,F)){d.push(C[j]);C[j]=null;}}P=P.then(jQuery.proxy(e.invokeActions,e,"EAM_OBJPG_MAINTENANCEORDER_SRV.EAM_OBJPG_MAINTENANCEORDER_SRV_Entities/"+a,d,M)).catch(jQuery.noop);}return P;},_prepareModel:function(){if(this._oModel.getDeferredGroups().indexOf("BreakoutActionParameters")!==-1){return;}var g=this._oModel.getDeferredGroups();g.push("BreakoutActionParameters");this._oModel.setDeferredGroups(g);}});});
